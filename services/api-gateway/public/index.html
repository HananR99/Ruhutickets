<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <title>RuhuTickets</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root{
      --bg: #f7f7f8;
      --panel: #ffffff;
      --text: #111827;
      --muted: #6b7280;
      --border: #e5e7eb;
      --ring: #2563eb20;
      --brand: #2563eb;
      --brand-600:#1d4ed8;
      --success:#0e9f6e;
      --danger:#dc2626;
      --card-radius: 14px;
      --shadow: 0 1px 2px rgba(0,0,0,.06), 0 8px 24px rgba(0,0,0,.06);
      --shadow-sm: 0 1px 2px rgba(0,0,0,.06);
      --table-stripe:#fafafa;
      --tab-bg:#ffffff;
      --tab-border:#e5e7eb;
      --tab-active-bg:#111827;
      --tab-active-fg:#ffffff;
    }
    @media (prefers-color-scheme: dark){
      :root{
        --bg:#0b0d10;
        --panel:#111317;
        --text:#e5e7eb;
        --muted:#9ca3af;
        --border:#1f242b;
        --ring:#3b82f620;
        --brand:#3b82f6;
        --brand-600:#2563eb;
        --success:#10b981;
        --danger:#ef4444;
        --table-stripe:#0f1216;
        --tab-bg:#0e1115;
        --tab-border:#1f242b;
        --tab-active-bg:#e5e7eb;
        --tab-active-fg:#0b0d10;
      }
    }

    /* Base */
    *{box-sizing:border-box}
    html,body{height:100%}
    body {
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, "Helvetica Neue", Arial, "Apple Color Emoji","Segoe UI Emoji";
      margin:0;
      color:var(--text);
      background:radial-gradient(1200px 600px at 10% -10%, #2563eb0d, transparent 60%), var(--bg);
    }

    /* App Shell */
    .container { max-width: 1400px; margin: 0 auto; padding: 12px; }
    .topbar {
      position: sticky; top: 0; z-index: 1000;
      backdrop-filter: saturate(180%) blur(8px);
      background: color-mix(in oklab, var(--panel) 88%, transparent);
      border-bottom: 1px solid var(--border);
    }
    .topbar__inner { max-width: 1200px; margin: 0 auto; padding: 14px 24px; display:flex; align-items:center; gap:16px; }
    .brand { display:flex; align-items:center; gap:12px; font-weight:700; letter-spacing:.2px; }
    .brand__dot{ width:12px; height:12px; border-radius:50%; background: conic-gradient(from 0deg, var(--brand), var(--success)); box-shadow: 0 0 0 6px var(--ring); }
    .brand small{ color:var(--muted); font-weight:500 }

    /* Buttons */
    button {
      padding: 10px 14px;
      border-radius: 10px;
      border: 1px solid var(--border);
      background: var(--panel);
      color: var(--text);
      cursor: pointer;
      transition: transform .03s ease, box-shadow .2s ease, border-color .2s ease, background .2s ease;
      box-shadow: var(--shadow-sm);
    }
    button:hover { box-shadow: var(--shadow); }
    button:active { transform: translateY(1px); }
    .btn-primary{
      background: linear-gradient(180deg, var(--brand), var(--brand-600));
      color: #fff;
      border-color: transparent;
    }
    .btn-outline{
      background: transparent;
      border-color: var(--brand);
      color: var(--brand);
    }
    .btn-danger{
      border-color: color-mix(in oklab, var(--danger) 40%, var(--border));
      color: var(--danger);
      background: transparent;
    }

    /* Inputs */
    input, select {
      padding: 10px 12px;
      border-radius: 10px;
      border: 1px solid var(--border);
      background: var(--panel);
      color: var(--text);
      outline: none;
      transition: border-color .2s ease, box-shadow .2s ease;
      box-shadow: var(--shadow-sm) inset;
    }
    input:focus, select:focus { border-color: var(--brand); box-shadow: 0 0 0 4px var(--ring); }
    input::placeholder { color: var(--muted); }

    /* Layout Helpers */
    .row { display:flex; gap:10px; align-items:center; flex-wrap:wrap; margin: 10px 0 }
    .grid { display:grid; grid-template-columns: repeat(auto-fill, minmax(320px, 1fr)); gap:14px }
    .muted { color: var(--muted); font-size: .92em }
    .ok { color: var(--success) } .err { color: var(--danger) }

    /* Cards */
    .card {
      border: 1px solid var(--border);
      border-radius: var(--card-radius);
      padding: 14px;
      background: var(--panel);
      box-shadow: var(--shadow);
    }
    .card h2 { margin: 0 0 6px 0; font-size: 1.05rem }
    .section { display:grid; gap:16px }

    /* Fix buyer card overflow caused by reservationId input */
    .card .row { width: 100%; }
    .card .row > * { min-width: 0; }            
    .card .row .rid {
      flex: 1 1 260px;                          
      width: 100%;                              
      max-width: 100%;
    }
    .card .row .pay { flex: 0 0 auto; }         

    /* Tabs */
    .tabs { display:flex; gap:10px; }
    .tab {
      padding: 10px 14px;
      border-radius: 999px;
      border: 1px solid var(--tab-border);
      background: var(--tab-bg);
      cursor: pointer;
      user-select:none;
    }
    .tab.active { background: var(--tab-active-bg); color: var(--tab-active-fg); border-color: transparent; box-shadow: var(--shadow) }

    /* Tables */
    table { border-collapse: collapse; width:100%; overflow:hidden; border-radius: 12px; }
    thead th {
      background: linear-gradient(180deg, #f6f7f9, #f1f2f4);
      color:#3b3f45;
      border-bottom:1px solid var(--border);
    }
    @media (prefers-color-scheme: dark){
      thead th { background: linear-gradient(180deg, #14181e, #11151a); color: #cfd3da; }
    }
    td, th { border: 1px solid var(--border); padding: 10px 12px; text-align:left; }
    tbody tr:nth-child(odd){ background: var(--table-stripe); }
    tbody tr:hover{ outline: 2px solid var(--ring); }

    /* Flash */
    #flash {
      position:sticky; top:64px; left:0; right:0; z-index:9999;
      background: color-mix(in oklab, var(--success) 10%, var(--panel));
      border: 1px solid color-mix(in oklab, var(--success) 40%, var(--border));
      color: color-mix(in oklab, var(--success) 70%, var(--text));
      padding:10px 14px; margin:12px auto; border-radius:12px; display:none;
      max-width: 1200px; box-shadow: var(--shadow);
      animation: flash-in .25s ease-out;
    }
    @keyframes flash-in { from { opacity:0; transform: translateY(-4px);} to { opacity:1; transform: translateY(0);} }

    /* Header actions */
    .top-actions { margin-left:auto; display:flex; gap:8px; align-items:center }
    #btnLogout { margin:0 }

    /* Page headings */
    .page-head { display:flex; align-items:baseline; justify-content:space-between; gap:12px; margin: 18px 0 12px }
    h1 { font-size: 1.6rem; margin: 0 }
    .subtitle { color:var(--muted); font-weight:500 }

    /* Fine-tune small screens */
    @media (max-width: 520px){
      .topbar__inner{ padding: 12px 16px; }
      .container{ padding: 16px; }
      .grid{ grid-template-columns: 1fr; }
      .row{ gap:8px }
    }
  </style>
</head>
<body>
  <!-- Top bar -->
  <div class="topbar">
    <div class="topbar__inner">
      <div class="brand">
        <span class="brand__dot" aria-hidden="true"></span>
        <div>RuhuTickets <small>Demo</small></div>
      </div>
      <div class="tabs" style="margin-left:12px">
        <div id="tab-buyer" class="tab">User</div>
        <div id="tab-admin" class="tab">Admin</div>
      </div>
      <div class="top-actions">
        <button id="btnLogout" class="btn-outline">Log Out</button>
      </div>
    </div>
  </div>

  <!-- Flash message -->
  <div id="flash"></div>

  <!-- Main -->
  <div class="container">
    <div class="page-head">
      <h1>Events & Management</h1>
      <div class="subtitle">Simple, fast ticketing</div>
    </div>

    <div id="buyer" class="section"></div>
    <div id="admin" class="section" style="display:none"></div>
  </div>

  <script>
    document.getElementById('btnLogout').onclick = () => {
      localStorage.removeItem('jwt');
      window.location.href = 'login.html';
    };

    const buyerEl = document.getElementById('buyer');
    const adminEl = document.getElementById('admin');
    const el      = html => {
      const d = document.createElement('div');
      d.innerHTML = html.trim();
      return d.firstChild;
    };

    function errToText(e){
      const data = e?.data?.error ?? e?.data ?? e;
      if (!data) return 'Unknown error';
      if (typeof data === 'string') return data;
      if (Array.isArray(data)) return data.map(errToText).join(', ');
      if (data.message) return data.message;
      try { return JSON.stringify(data); } catch { return String(data); }
    }


    // —— enforce JWT presence & parse role —— 
    const token = localStorage.getItem('jwt');
    if (!token) {
      // no token → back to login
      window.location.href = 'login.html';
      throw new Error('Redirecting to login');
    }
    function parseJwt(t) {
      const p = t.split('.')[1].replace(/-/g,'+').replace(/_/g,'/');
      return JSON.parse(atob(p));
    }
    const claims = parseJwt(token);
    const role   = claims.role || '';

    if (role === 'buyer') {
      document.getElementById('tab-admin').style.display = 'none';
    } else {
      document.getElementById('tab-buyer').style.display = 'none';
    }

    const api = (p, opt = {}) => fetch(p, {
      headers: {
        'Content-Type': 'application/json',
        'Authorization': 'Bearer ' + token,
        ...(opt.headers||{})
      },
      ...opt
    }).then(async r => {
      const ct   = r.headers.get('content-type') || '';
      const data = ct.includes('application/json') ? await r.json() : await r.text();
      if (!r.ok) throw Object.assign(
        new Error(typeof data === 'string' ? data : (data.error || 'HTTP ' + r.status)),
        { status: r.status, data }
      );
      return data;
    });

    const tabBuyer = document.getElementById('tab-buyer');
    const tabAdmin = document.getElementById('tab-admin');
    tabBuyer.onclick = () => {
      tabBuyer.classList.add('active');
      tabAdmin.classList.remove('active');
      buyerEl.style.display  = 'grid';
      adminEl.style.display  = 'none';
    };
    tabAdmin.onclick = () => {
      tabAdmin.classList.add('active');
      tabBuyer.classList.remove('active');
      adminEl.style.display = 'grid';
      buyerEl.style.display = 'none';
    };

    if (role === 'admin') tabAdmin.click();
    else                  tabBuyer.click();

    renderBuyer();
    renderAdmin();

    async function renderBuyer(){
      buyerEl.innerHTML = '';
      let events = [];
      try { events = await api('/api/v1/events'); } catch (_) {}
      if (!Array.isArray(events) || !events.length) {
        buyerEl.appendChild(el(`<div class="card">No events yet. Create one in Admin tab.</div>`));
        return;
      }
      const wrap = el(`<div class="grid"></div>`);
      buyerEl.appendChild(wrap);

      for (const e of events) {
        const card = el(`
          <div class="card">
            <h2>${e.name}</h2>
            <div class="muted">${new Date(e.start_time).toLocaleString()} @ ${e.venue}</div>
            <div class="row">
              <select class="tt"></select>
              <input class="qty" type="number" min="1" value="2" />
              <button class="reserve btn-primary">Reserve</button>
              <span class="reserveOut muted"></span>
            </div>
            <div class="row">
              <input class="rid" placeholder="reservationId" size="45" />
              <button class="pay btn-primary">Pay & Commit</button>
              <span class="payOut muted"></span>
            </div>
          </div>
        `);
        wrap.appendChild(card);

        // load ticket types
        try {
          const sel   = card.querySelector('.tt');
          sel.innerHTML = '';
          const types = await api(`/api/v1/inventory/ticket-types?eventId=${encodeURIComponent(e.id)}`);
          if (Array.isArray(types) && types.length) {
            for (const t of types) {
              const o = document.createElement('option');
              o.value = t.id;
              o.textContent = `${t.name} — ${(t.price_cents/100).toFixed(2)} ${t.currency} (left: ${t.total_qty - t.sold_qty})`;
              sel.appendChild(o);
            }
          } else {
            sel.appendChild(new Option('No ticket types',''));
          }
        } catch {
          const out = card.querySelector('.reserveOut');
          out.className = 'err';
          out.textContent = 'Failed to load ticket types';
        }

        // reserve action
        card.querySelector('.reserve').onclick = async () => {
          const ticketTypeId = card.querySelector('.tt').value;
          const qty          = +card.querySelector('.qty').value;
          const out          = card.querySelector('.reserveOut');
          out.className='muted'; out.textContent='Reserving...';
          try {
            const r = await api('/api/v1/inventory/reserve', {
              method:'POST',
              body: JSON.stringify({ ticketTypeId, qty })
            });
            out.className='ok';
            out.textContent = `Reservation: ${r.reservationId} (expires in ${r.expiresInSeconds}s)`;
            card.querySelector('.rid').value = r.reservationId;
          } catch (e) {
            out.className='err';
            out.textContent = e.message || 'Reserve failed';
          }
        };

        // pay action
        card.querySelector('.pay').onclick = async () => {
          const rid = card.querySelector('.rid').value.trim();
          const out = card.querySelector('.payOut');
          out.className='muted'; out.textContent='Paying...';
          try {
            const r    = await api('/api/v1/webhooks/payment/charge', {
              method:'POST',
              body: JSON.stringify({ reservationId: rid })
            });
            const info = r.reservation || {};
            const when = info.start_time ? new Date(info.start_time).toLocaleString() : '';
            const qty  = (info.qty ?? '').toString();
            const type = info.ticket_type ? ` × ${info.ticket_type}` : '';
            const evt  = info.event_name ? ` for ${info.event_name}` : '';
            const line = info.event_name
              ? `Booked ${qty}${type}${evt}${when ? ' — ' + when : ''}`
              : (r.message || 'Payment successful');
            out.className='ok';
            out.textContent = '✅ ' + line;
            showFlash('✅ ' + line);
            renderBuyer();
            renderAdmin();
          } catch (e) {
            out.className='err';
            out.textContent = e.message || 'Payment failed';
          }
        };
      }
    }

    // —— admin UI —— 
    async function renderAdmin(){
      adminEl.innerHTML = '';

      // Create Event
      const evCard = el(`
        <div class="card">
          <h2>Create Event</h2>
          <div class="row">
            <input id="name" placeholder="name" />
            <input id="venue" placeholder="venue" />
          </div>
          <div class="row">
            <input id="start" type="datetime-local" />
            <input id="end"   type="datetime-local" />
            <button id="createEv" class="btn-primary">Create</button>
            <span id="evOut" class="muted"></span>
          </div>
        </div>
      `);
      adminEl.appendChild(evCard);

      // Create Ticket Type
      const ttCard = el(`
        <div class="card">
          <h2>Create Ticket Type</h2>
          <div class="row">
            <select id="eventSelect"></select>
            <input id="tname" placeholder="name (VIP/General)" />
          </div>
          <div class="row">
            <input id="price" type="number" placeholder="price cents (e.g., 50000)" />
            <input id="cur"   value="LKR" size="6" />
            <input id="qty"   type="number" placeholder="total qty" />
            <button id="createTT" class="btn-primary">Add</button>
            <span id="ttOut" class="muted"></span>
          </div>
        </div>
      `);
      adminEl.appendChild(ttCard);

      // Manage Events table
      const listCard = el(`
        <div class="card">
          <h2>Manage Events</h2>
          <div class="row">
            <button id="refreshEv" class="btn-outline">Refresh</button>
          </div>
          <div id="evList"></div>
        </div>
      `);
      adminEl.appendChild(listCard);

      async function loadEventsTable(){
        const [rows, stats] = await Promise.all([
          api('/api/v1/events'),
          api('/api/v1/inventory/event-stats')
        ]);
        const sMap = Object.fromEntries(stats.map(s => [s.id,s]));

        if (!rows.length) {
          listCard.querySelector('#evList').innerHTML = '<div class="muted">No events yet.</div>';
          return;
        }

        listCard.querySelector('#evList').innerHTML = `
          <table>
            <thead>
              <tr><th>name</th><th>venue</th><th>start</th><th>end</th><th>sold (by type)</th><th></th></tr>
            </thead>
            <tbody>
              ${rows.map(r => {
                const st = sMap[r.id]||{sold_total:0,by_type:[]};
                const by = st.by_type.map(bt=>`${bt.name}: ${bt.sold}`).join(', ');
                return `
                  <tr data-id="${r.id}">
                    <td><input class="en" value="${r.name}"/></td>
                    <td><input class="ev" value="${r.venue}"/></td>
                    <td><input class="es" type="datetime-local" value="${toLocalDT(r.start_time)}"/></td>
                    <td><input class="ee" type="datetime-local" value="${toLocalDT(r.end_time)}"/></td>
                    <td>${st.sold_total}${by?` (${by})`:''}</td>
                    <td>
                      <button class="save btn-primary">Save</button>
                      <button class="del btn-danger">Delete</button>
                    </td>
                  </tr>`;
              }).join('')}
            </tbody>
          </table>`;
        // Save/Delete handlers
        listCard.querySelectorAll('.save').forEach(btn=>{
          btn.onclick = async ()=>{
            const tr = btn.closest('tr'), id = tr.dataset.id;
            const payload = {
              name: tr.querySelector('.en').value,
              venue: tr.querySelector('.ev').value,
              start_time: new Date(tr.querySelector('.es').value).toISOString(),
              end_time:   new Date(tr.querySelector('.ee').value).toISOString()
            };
            await api(`/api/v1/events/${id}`, { method:'PUT', body: JSON.stringify(payload) });
            renderBuyer(); renderAdmin();
          };
        });
        listCard.querySelectorAll('.del').forEach(btn=>{
          btn.onclick = async ()=>{
            const tr = btn.closest('tr'), id = tr.dataset.id;
            if (!confirm('Delete this event and related data?')) return;
            await api(`/api/v1/events/${id}`, { method:'DELETE' });
            renderBuyer(); renderAdmin();
          };
        });
      }
      function toLocalDT(iso){
        const d = new Date(iso), pad = n=>String(n).padStart(2,'0');
        return `${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())}`
             + `T${pad(d.getHours())}:${pad(d.getMinutes())}`;
      }

      listCard.querySelector('#refreshEv').onclick = loadEventsTable;
      
      await loadEventsTable();

      // Reservations section
      const resCard = el(`
        <div class="card">
          <h2>Reservations</h2>
          <div class="row">
            <select id="resEvent"><option value="">All events</option></select>
            <button id="refreshRes" class="btn-outline">Refresh</button>
          </div>
          <div id="resTbl"></div>
        </div>
      `);
      adminEl.appendChild(resCard);

      // fill event dropdowns
      const evSel  = ttCard.querySelector('#eventSelect');
      const resSel = resCard.querySelector('#resEvent');
      (await api('/api/v1/events')||[]).forEach(ev=>{
        evSel .appendChild(new Option(`${ev.name} @ ${ev.venue}`, ev.id));
        resSel.appendChild(new Option(ev.name, ev.id));
      });

      // create event handler
      evCard.querySelector('#createEv').onclick = async () => {
        const name  = evCard.querySelector('#name').value.trim();
        const venue = evCard.querySelector('#venue').value.trim();
        const start = evCard.querySelector('#start').value;
        const end   = evCard.querySelector('#end').value;
        const out   = evCard.querySelector('#evOut');

        out.className = 'muted';
        out.textContent = 'Creating...';

        if (!name || !venue || !start || !end) {
          out.className = 'err';
          out.textContent = 'Please fill name, venue, start, and end.';
          return;
        }

        const s = new Date(start);
        const e = new Date(end);
        if (isNaN(+s) || isNaN(+e) || e <= s) {
          out.className = 'err';
          out.textContent = 'End time must be after start time.';
          return;
        }

        try {
          const r = await api('/api/v1/events', {
            method: 'POST',
            body: JSON.stringify({
              name, venue,
              start_time: s.toISOString(),
              end_time:   e.toISOString()
            })
          });
          out.className = 'ok';
          out.textContent = 'Created: ' + r.id;

          // evSel / resSel must already be defined above this handler
          evSel.appendChild(new Option(`${r.name} @ ${r.venue}`, r.id));
          resSel.appendChild(new Option(r.name, r.id));
          evSel.value = r.id;

          renderBuyer();
        } catch (e) {
          out.className = 'err';
          out.textContent = errToText(e);
        }
      };

      // create ticket type
      ttCard.querySelector('#createTT').onclick = async ()=>{
        const payload = {
          event_id:    evSel.value,
          name:        ttCard.querySelector('#tname').value.trim(),
          price_cents: +ttCard.querySelector('#price').value,
          currency:    ttCard.querySelector('#cur').value.trim(),
          total_qty:   +ttCard.querySelector('#qty').value
        };
        const out = ttCard.querySelector('#ttOut');
        out.className='muted'; out.textContent='Adding...';
        try {
          const r = await api('/api/v1/inventory/ticket-types',{
            method:'POST',
            body: JSON.stringify(payload)
          });
          out.className='ok';
          out.textContent = 'Added: '+r.id;
          renderBuyer();
        } catch(e) {
          out.className='err';
          out.textContent = errToText(e);
        }
      };

      // load reservations
      async function loadRes(){
        const chosen = resSel.value;
        let rows = [];
        try {
          rows = await api(`/api/v1/inventory/reservations${chosen ? ('?eventId='+encodeURIComponent(chosen)) : ''}`);
        } catch(e) {
          resCard.querySelector('#resTbl').innerHTML = `<div class="err">${errToText(e)}</div>`;
          return;
        }
        if (!rows.length) {
          resCard.querySelector('#resTbl').innerHTML = `<div class="muted">No reservations yet.</div>`;
          return;
        }
        const html = `
          <table>
            <thead>
              <tr><th>id</th><th>event</th><th>booked time</th><th>tickets</th><th>status</th></tr>
            </thead>
            <tbody>
              ${rows.map(r=>`
                <tr>
                  <td>${r.id}</td>
                  <td>${r.event_name}</td>
                  <td>${r.booked_at?new Date(r.booked_at).toLocaleString():''}</td>
                  <td>${r.qty}${r.ticket_type?` (${r.ticket_type})`:''}</td>
                  <td>${r.status}</td>
                </tr>
              `).join('')}
            </tbody>
          </table>
        `;
        resCard.querySelector('#resTbl').innerHTML = html;
      }
      resCard.querySelector('#refreshRes').onclick = loadRes;
      resSel.onchange = loadRes;
      loadRes();
    }
 
    function showFlash(msg){
      const box = document.getElementById('flash');
      box.textContent = msg;
      box.style.display = 'block';
      clearTimeout(showFlash._t);
      showFlash._t = setTimeout(()=> box.style.display='none', 6000);
    }
  </script>
</body>
</html>
